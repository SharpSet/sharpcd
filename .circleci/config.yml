version: 2

variables:
  DOCKER_DRIVER: overlay2

jobs:
  testing:
    docker:
      - image: circleci/golang:1.12

    steps:
      - checkout

      - run:
          name: compile
          command: |
            go get github.com/joho/godotenv
            go get /go/src/gopkg.in/yaml.v2
            go get golang.org/x/crypto/bcrypt
            go get golang.org/x/sys/unix

            go build -o "sharpcd" ./src

          environment:
            GOOS: "linux"

      - run:
          name: Get Keys
          command: |
            mkdir ./private
            openssl req -x509 -nodes -days 730 -newkey rsa:2048 -keyout ./private/server.key -out ./private/server.crt -config ./.circleci/openssl.conf -extensions 'v3_req'

      - run:
          name: Create Password
          command: |
            ./sharpcd --pass Pass123 setpass

      - run:
          name: run_server
          background: true
          command: |
            ./sharpcd server

      - run:
          name: testing
          command: |
            sleep 2
            ./sharpcd --pass Pass123

workflows:
  version: 2
  workflow:
    jobs:
      - testing
